# Anomaly Detection System for Remote Printer

## Project Overview
This project implements an anomaly detection system for remote Printer, where the incoming sensor data is processed to detect anomalies based on printer-specific thresholds. The backend of the application uses AWS services like AWS IoT, AWS Lambda, and DynamoDB to achieve scalable anomaly detection. The project also outputs the devices sorted by the number of anomaly events detected.

---

## Project Files

### 1. `emit_json_data.py`
**Description:**  
This Python script is responsible for simulating the printer sensor data stream by sending messages to the AWS IoT topic. It reads data from the `printer_iot_data.json` file and publishes it to the specified IoT topic (`anom/detect`).

**Usage:**  
Run this script to send test data to AWS IoT for processing by the backend Lambda function.

**Command:**
```bash
python3 emit_json_data.py anom/detect printer_iot_data.json
```

### 2. `lambda_function.py`
**Description:**  
This is the main Lambda function that processes the incoming device data from AWS IoT. It checks whether the sensor values exceed the defined thresholds for a certain time window. If the thresholds are violated for long enough, it triggers an anomaly event by incrementing the `EventCount` in DynamoDB.

**Purpose:**
- Fetch device thresholds from DynamoDB.
- Compare incoming data with thresholds.
- Update `EventCount` and `OutOfBoundsCount` in DynamoDB.
- Optionally, republish the results to another IoT topic (`anom/pred`).

### 3. `iot_lambda_role.json`
**Description:**  
This JSON file defines the AWS IAM role that allows AWS IoT and AWS Lambda to interact with DynamoDB and other services.

**Usage:**  
This policy document gives AWS Lambda and AWS IoT the necessary permissions to access DynamoDB, publish messages to IoT topics, and write to CloudWatch logs.

**AWS Command:**
```bash
aws iam create-role --role-name iot_lambda_role --assume-role-policy-document file://iot_lambda_role.json
```

### 4. `anom_det_policy.json`
**Description:**  
This JSON file contains the policy that defines what permissions the Lambda function will have, specifically related to accessing DynamoDB, IoT, and CloudWatch.

**Usage:**  
Attach this policy to the Lambda execution role (`iot_lambda_role`) to give it access to perform necessary tasks such as getting and putting items in DynamoDB.

**AWS Command:**
```bash
aws iam create-policy --policy-name anom_det_policy --policy-document file://anom_det_policy.json
```

### 5. `anomaly_rule.json`
**Description:**  
This JSON file defines the AWS IoT rule that listens to the incoming messages on the `anom/detect` topic. Whenever a message is received, it triggers the Lambda function to process the data.

**Usage:**  
Create a rule in AWS IoT to trigger the Lambda function on incoming device data.

**AWS Command:**
```bash
aws iot create-topic-rule --rule-name anomaly_detection_lambda --topic-rule-payload file://anomaly_rule.json
```

### 6. `lambda_function.zip`
**Description:**  
This is a compressed version of the Lambda function code, ready for deployment.

**Usage:**  
This file can be uploaded directly to AWS Lambda for deployment.

**Purpose:**  
It allows you to deploy the Lambda function with all required dependencies (if any).

### 7. `tests/`
**Description:**  
The `tests` folder contains test scripts to validate the functionality of the Lambda function, IoT rules, and the overall anomaly detection system.

**Usage:**  
Run these tests to ensure that the Lambda function and IoT setup are working as expected.

### 8. `.pytest_cache/`
**Description:**  
This directory contains cache information generated by pytest when running the test scripts. It helps speed up test runs by caching certain test results.

**Usage:**  
This folder is automatically generated when you run pytest to validate your code.

---

## How to Run the Backend Application

### 1. Set up AWS IoT and Lambda:
- Create the necessary AWS services:
  - AWS IoT topic (`anom/detect`).
  - DynamoDB table (`DeviceEventsTable`).
  ```bash
     aws dynamodb create-table \
    --table-name PrinterProfiles \
    --attribute-definitions AttributeName=printerId,AttributeType=S \
    --key-schema AttributeName=printerId,KeyType=HASH \
    --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
    --region eu-north-1
  ```
  - Lambda function (using `lambda_function.py`).
    ```bash
    aws lambda create-function \
    --function-name anomaly_detector \
    --runtime python3.8 \
    --role arn:aws:iam::533267262133:role/iot_lambda_role \
    --handler lambda_function.lambda_handler \
    --timeout 15 \
    --memory-size 512 \
    --region eu-north-1 \
    --zip-file fileb://lambda_function.zip
  ```
- Attach the necessary IAM roles to Lambda and IoT.

### 2. Run the `emit_json_data.py` script:
This script will send simulated device data to AWS IoT for processing.

**Example command:**
```bash
python3 emit_json_data.py anom/detect printer_iot_data.json
```

### 3. Monitor AWS CloudWatch logs:
- View logs of Lambda function executions to check for processed results and anomaly detection outputs.

### 4. Check DynamoDB for updates:
- Ensure that the `EventCount` and `OutOfBoundsCount` for each device are being updated as expected.



  aws dynamodb create-table \
    --table-name PrinterProfiles \
    --attribute-definitions AttributeName=PrinterId,AttributeType=S \
    --key-schema AttributeName=PrinterId,KeyType=HASH \
    --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
    --region eu-north-1

Explanation:

--table-name PrinterProfiles: Specifies the name of the table to be created.
--attribute-definitions: Defines the attributes for the table, here PrinterId as a string (S).
--key-schema: Defines the primary key, with PrinterId as the partition key (HASH).
--provisioned-throughput: Sets the read and write capacity units (5 each).
--region eu-north-1: Specifies the AWS region (Stockholm).
This command creates a table PrinterProfiles with a partition key PrinterId in the Stockholm region with provisioned throughput settings.

aws dynamodb put-item \
  --table-name PrinterProfiles \
  --item '{
    "PrinterId": {"S": "Printer1"},
    "EventCount": {"N": "0"},
    "OutOfBoundsCount": {"N": "0"},
    "Thresholds": {"M": {
      "Lower": {"N": "20"},
      "Upper": {"N": "80"}
    }},
    "Window": {"N": "10"}
  }' \
  --region eu-north-1

Explanation:
--table-name PrinterProfiles: Specifies the table to add the item to.
--item: Provides the data you want to insert.
S denotes a string value.
N denotes a number.
M denotes a map (or dictionary), which is used for nested objects.
This command will insert the item with the PrinterId of Printer1 and the associated fields into your PrinterProfiles table.


aws dynamodb put-item \
  --table-name PrinterProfiles \
  --item '{
    "PrinterId": {"S": "Printer2"},
    "EventCount": {"N": "0"},
    "OutOfBoundsCount": {"N": "0"},
    "Thresholds": {"M": {
      "Lower": {"N": "30"},
      "Upper": {"N": "90"}
    }},
    "Window": {"N": "6"}
  }' \
  --region eu-north-1


aws iam create-role --role-name iot_lambda_role --assume-role-policy-document file://iot_lambda_role.json
aws iam create-policy --policy-name anom_det_policy --policy-document file://anom_det_policy.json
aws iam attach-role-policy --role-name iot_lambda_role --policy-arn arn:aws:iam::533267262133:policy/anom_det_policy



  aws lambda create-function \
    --function-name anomaly_detector \
    --runtime python3.8 \
    --role arn:aws:iam::533267262133:role/iot_lambda_role \
    --handler lambda_function.lambda_handler \
    --timeout 15 \
    --memory-size 512 \
    --region eu-north-1 \
    --zip-file fileb://lambda_function.zip


aws iot create-topic-rule \
  --rule-name anomaly_detection_lambda \
  --topic-rule-payload file://anomaly_rule.json

aws lambda add-permission \
  --function-name "anomaly_detector" \
  --region "eu-north-1" \
  --principal iot.amazonaws.com \
  --source-arn arn:aws:iot:eu-north-1:533267262133:rule/anomaly_detection_lambda \
  --source-account "533267262133" \
  --statement-id "AllowIoTInvoke" \
  --action "lambda:InvokeFunction"

